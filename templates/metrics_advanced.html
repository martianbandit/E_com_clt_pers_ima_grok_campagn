{% extends "layout.html" %}

{% block title %}Métriques Avancées - NinjaLead{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-1 text-white">
                        <i class="fas fa-chart-line me-2"></i>Métriques de Performance
                    </h1>
                    <p class="text-muted mb-0">Analyse détaillée des performances et utilisation</p>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-light btn-sm" onclick="exportMetrics()">
                        <i class="fas fa-download me-1"></i>Exporter
                    </button>
                    <button class="btn btn-outline-light btn-sm" onclick="refreshMetrics()">
                        <i class="fas fa-sync-alt me-1"></i>Actualiser
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtres -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-dark border-secondary">
                <div class="card-body">
                    <form method="GET" class="row g-3">
                        <div class="col-md-3">
                            <label for="category" class="form-label text-light">Catégorie</label>
                            <select class="form-select bg-dark text-light border-secondary" id="category" name="category">
                                <option value="">Toutes les catégories</option>
                                <option value="generation" {{ 'selected' if category == 'generation' }}>Génération</option>
                                <option value="analysis" {{ 'selected' if category == 'analysis' }}>Analyse</option>
                                <option value="marketing" {{ 'selected' if category == 'marketing' }}>Marketing</option>
                                <option value="user" {{ 'selected' if category == 'user' }}>Utilisateur</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="start_date" class="form-label text-light">Date de début</label>
                            <input type="date" class="form-control bg-dark text-light border-secondary" id="start_date" name="start_date" value="{{ start_date }}">
                        </div>
                        <div class="col-md-3">
                            <label for="end_date" class="form-label text-light">Date de fin</label>
                            <input type="date" class="form-control bg-dark text-light border-secondary" id="end_date" name="end_date" value="{{ end_date }}">
                        </div>
                        <div class="col-md-3">
                            <label for="limit" class="form-label text-light">Limite</label>
                            <select class="form-select bg-dark text-light border-secondary" id="limit" name="limit">
                                <option value="50" {{ 'selected' if limit == 50 }}>50</option>
                                <option value="100" {{ 'selected' if limit == 100 }}>100</option>
                                <option value="500" {{ 'selected' if limit == 500 }}>500</option>
                                <option value="1000" {{ 'selected' if limit == 1000 }}>1000</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-filter me-1"></i>Appliquer les filtres
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistiques principales -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-dark border-secondary h-100">
                <div class="card-body text-center">
                    <div class="display-6 text-primary mb-2">{{ total_metrics }}</div>
                    <h6 class="text-light mb-0">Total Métriques</h6>
                    <small class="text-muted">Depuis le début</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-dark border-secondary h-100">
                <div class="card-body text-center">
                    <div class="display-6 text-success mb-2">{{ "%.1f"|format(success_rate) }}%</div>
                    <h6 class="text-light mb-0">Taux de Succès</h6>
                    <small class="text-muted">{{ success_count }} / {{ total_metrics }}</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-dark border-secondary h-100">
                <div class="card-body text-center">
                    <div class="display-6 text-warning mb-2">{{ "%.2f"|format(avg_time) }}s</div>
                    <h6 class="text-light mb-0">Temps Moyen</h6>
                    <small class="text-muted">Réponse moyenne</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-dark border-secondary h-100">
                <div class="card-body text-center">
                    <div class="display-6 text-danger mb-2">{{ error_count }}</div>
                    <h6 class="text-light mb-0">Erreurs</h6>
                    <small class="text-muted">À investiguer</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Graphiques -->
    <div class="row mb-4">
        <!-- Tendances quotidiennes -->
        <div class="col-lg-8">
            <div class="card bg-dark border-secondary h-100">
                <div class="card-header bg-dark border-bottom border-secondary">
                    <h5 class="text-light mb-0">
                        <i class="fas fa-chart-area me-2"></i>Tendances (30 derniers jours)
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="dailyTrendsChart" height="300"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Répartition par catégorie -->
        <div class="col-lg-4">
            <div class="card bg-dark border-secondary h-100">
                <div class="card-header bg-dark border-bottom border-secondary">
                    <h5 class="text-light mb-0">
                        <i class="fas fa-chart-pie me-2"></i>Par Catégorie
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="categoryChart" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Performance horaire et top erreurs -->
    <div class="row mb-4">
        <div class="col-lg-6">
            <div class="card bg-dark border-secondary">
                <div class="card-header bg-dark border-bottom border-secondary">
                    <h5 class="text-light mb-0">
                        <i class="fas fa-clock me-2"></i>Performance par Heure (24h)
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="hourlyChart" height="200"></canvas>
                </div>
            </div>
        </div>
        
        <div class="col-lg-6">
            <div class="card bg-dark border-secondary">
                <div class="card-header bg-dark border-bottom border-secondary">
                    <h5 class="text-light mb-0">
                        <i class="fas fa-exclamation-triangle me-2"></i>Top Erreurs
                    </h5>
                </div>
                <div class="card-body">
                    {% if error_patterns %}
                        <div class="table-responsive">
                            <table class="table table-dark table-striped">
                                <thead>
                                    <tr>
                                        <th>Type</th>
                                        <th>Occurrences</th>
                                        <th>%</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for error in error_patterns %}
                                    <tr>
                                        <td>{{ error.name }}</td>
                                        <td><span class="badge bg-danger">{{ error.error_count }}</span></td>
                                        <td>{{ "%.1f"|format((error.error_count / error_count * 100) if error_count > 0 else 0) }}%</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center text-muted py-3">
                            <i class="fas fa-check-circle fa-2x mb-2"></i>
                            <p>Aucune erreur récente</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Statistiques détaillées par type -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-dark border-secondary">
                <div class="card-header bg-dark border-bottom border-secondary">
                    <h5 class="text-light mb-0">
                        <i class="fas fa-list me-2"></i>Détail par Type de Métrique
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-dark table-striped">
                            <thead>
                                <tr>
                                    <th>Type</th>
                                    <th>Total</th>
                                    <th>Succès</th>
                                    <th>Taux Succès</th>
                                    <th>Temps Moyen</th>
                                    <th>Performance</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for stat in metric_type_stats %}
                                {% set success_rate_type = (stat.success_count / stat.count * 100) if stat.count > 0 else 0 %}
                                <tr>
                                    <td>
                                        <code class="text-info">{{ stat.name }}</code>
                                    </td>
                                    <td>{{ stat.count }}</td>
                                    <td>{{ stat.success_count }}</td>
                                    <td>
                                        <span class="badge {% if success_rate_type >= 95 %}bg-success{% elif success_rate_type >= 80 %}bg-warning{% else %}bg-danger{% endif %}">
                                            {{ "%.1f"|format(success_rate_type) }}%
                                        </span>
                                    </td>
                                    <td>{{ "%.2f"|format(stat.avg_time or 0) }}s</td>
                                    <td>
                                        <div class="progress" style="height: 6px;">
                                            <div class="progress-bar {% if success_rate_type >= 95 %}bg-success{% elif success_rate_type >= 80 %}bg-warning{% else %}bg-danger{% endif %}" 
                                                 style="width: {{ success_rate_type }}%"></div>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Métriques récentes -->
    <div class="row">
        <div class="col-12">
            <div class="card bg-dark border-secondary">
                <div class="card-header bg-dark border-bottom border-secondary">
                    <h5 class="text-light mb-0">
                        <i class="fas fa-history me-2"></i>Métriques Récentes ({{ recent_metrics|length }})
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-dark table-striped">
                            <thead>
                                <tr>
                                    <th>Timestamp</th>
                                    <th>Type</th>
                                    <th>Catégorie</th>
                                    <th>Statut</th>
                                    <th>Temps</th>
                                    <th>Données</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for metric in recent_metrics %}
                                <tr>
                                    <td>
                                        <small class="text-muted">
                                            {{ metric.created_at.strftime('%d/%m/%Y %H:%M:%S') }}
                                        </small>
                                    </td>
                                    <td>
                                        <code class="text-info">{{ metric.name }}</code>
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary">{{ metric.category or 'N/A' }}</span>
                                    </td>
                                    <td>
                                        {% if metric.status %}
                                            <span class="badge bg-success">
                                                <i class="fas fa-check"></i> Succès
                                            </span>
                                        {% else %}
                                            <span class="badge bg-danger">
                                                <i class="fas fa-times"></i> Erreur
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if metric.execution_time %}
                                            <span class="text-warning">{{ "%.2f"|format(metric.execution_time) }}s</span>
                                        {% else %}
                                            <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if metric.data %}
                                            <button class="btn btn-sm btn-outline-light" onclick="showMetricData({{ metric.data|tojson }})">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal pour afficher les données de métriques -->
<div class="modal fade" id="metricDataModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark">
            <div class="modal-header border-bottom border-secondary">
                <h5 class="modal-title text-light">Données de la Métrique</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <pre id="metricDataContent" class="text-light bg-black p-3 rounded"></pre>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Configuration Chart.js pour le thème sombre
Chart.defaults.color = '#ffffff';
Chart.defaults.borderColor = '#374151';

// Données pour les graphiques
const chartData = {{ chart_data|tojson }};

// Graphique des tendances quotidiennes
const dailyCtx = document.getElementById('dailyTrendsChart').getContext('2d');
new Chart(dailyCtx, {
    type: 'line',
    data: {
        labels: chartData.daily_trends.dates,
        datasets: [
            {
                label: 'Total',
                data: chartData.daily_trends.totals,
                borderColor: '#3B82F6',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                tension: 0.4
            },
            {
                label: 'Succès',
                data: chartData.daily_trends.successes,
                borderColor: '#10B981',
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                tension: 0.4
            },
            {
                label: 'Erreurs',
                data: chartData.daily_trends.errors,
                borderColor: '#EF4444',
                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                tension: 0.4
            }
        ]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'top',
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                grid: {
                    color: '#374151'
                }
            },
            x: {
                grid: {
                    color: '#374151'
                }
            }
        }
    }
});

// Graphique en camembert des catégories
const categoryCtx = document.getElementById('categoryChart').getContext('2d');
new Chart(categoryCtx, {
    type: 'doughnut',
    data: {
        labels: chartData.categories.labels,
        datasets: [{
            data: chartData.categories.counts,
            backgroundColor: [
                '#3B82F6',
                '#10B981',
                '#F59E0B',
                '#EF4444',
                '#8B5CF6',
                '#06B6D4'
            ]
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom',
            }
        }
    }
});

// Graphique des performances horaires
const hourlyCtx = document.getElementById('hourlyChart').getContext('2d');
new Chart(hourlyCtx, {
    type: 'bar',
    data: {
        labels: chartData.hourly_performance.hours.map(h => h + 'h'),
        datasets: [{
            label: 'Requêtes par heure',
            data: chartData.hourly_performance.counts,
            backgroundColor: 'rgba(59, 130, 246, 0.8)',
            borderColor: '#3B82F6',
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true,
                grid: {
                    color: '#374151'
                }
            },
            x: {
                grid: {
                    color: '#374151'
                }
            }
        }
    }
});

// Fonctions utilitaires
function showMetricData(data) {
    document.getElementById('metricDataContent').textContent = JSON.stringify(data, null, 2);
    new bootstrap.Modal(document.getElementById('metricDataModal')).show();
}

function exportMetrics() {
    // Implémenter l'export des métriques
    alert('Fonctionnalité d\'export en développement');
}

function refreshMetrics() {
    window.location.reload();
}
</script>
{% endblock %}