{% extends 'layout.html' %}

{% block title %}Fiche Produits - Générateur de contenu{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row mb-4">
        <div class="col-12">
            <h1>Génération de Fiches Produits</h1>
            <p class="lead">Créez des fiches produits optimisées, des descriptions SEO et des variantes de produits en français</p>
        </div>
    </div>

    <!-- Liste des produits existants -->
    {% if products %}
    <div class="card mb-5">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Produits existants</h5>
            <button type="button" class="btn btn-sm btn-outline-light" data-bs-toggle="modal" data-bs-target="#createProductModal">
                <i class="fas fa-plus me-1"></i> Nouveau produit
            </button>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-striped table-hover mb-0">
                    <thead>
                        <tr>
                            <th>Nom</th>
                            <th>Catégorie</th>
                            <th>Prix</th>
                            <th>Public cible</th>
                            <th>Contenu généré</th>
                            <th>Variantes</th>
                            <th>Créé le</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for product in products %}
                        <tr>
                            <td>{{ product.name }}</td>
                            <td>{{ product.category }}</td>
                            <td>{{ "%.2f"|format(product.price) }}€</td>
                            <td>
                                {% if product.target_audience %}
                                <span class="badge bg-info">{{ product.target_audience.name }}</span>
                                {% else %}
                                <span class="badge bg-secondary">Non défini</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if product.generated_description %}
                                <span class="badge bg-success">Généré</span>
                                {% else %}
                                <span class="badge bg-warning text-dark">Non généré</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if product.variants %}
                                <span class="badge bg-primary">{{ product.variants|length if product.variants is iterable else '0' }} variantes</span>
                                {% else %}
                                <span class="badge bg-secondary">Aucune</span>
                                {% endif %}
                            </td>
                            <td>{{ product.created_at.strftime('%d/%m/%Y') }}</td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <a href="{{ url_for('view_product', product_id=product.id) }}" class="btn btn-primary">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <a href="{{ url_for('edit_product', product_id=product.id) }}" class="btn btn-warning">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteProductModal{{ product.id }}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                                
                                <!-- Delete Modal -->
                                <div class="modal fade" id="deleteProductModal{{ product.id }}" tabindex="-1" aria-hidden="true">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title">Supprimer le produit</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body">
                                                Êtes-vous sûr de vouloir supprimer le produit <strong>{{ product.name }}</strong>?
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                                                <form action="{{ url_for('delete_product', product_id=product.id) }}" method="POST">
                                                    <button type="submit" class="btn btn-danger">Supprimer</button>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% else %}
    <div class="card mb-4">
        <div class="card-body">
            <div class="text-center p-4">
                <div class="mb-3">
                    <i class="fas fa-box fa-3x text-muted"></i>
                </div>
                <h4>Aucun produit créé</h4>
                <p class="text-muted">Commencez par créer un nouveau produit pour générer des fiches produits optimisées.</p>
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createProductModal">
                    <i class="fas fa-plus me-2"></i> Créer un produit
                </button>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Générateur de Contenu Produit -->
    <div class="card mb-5">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0">Générateur de Contenu Produit</h5>
        </div>
        <div class="card-body">
            <form action="{{ url_for('generate_product_content') }}" method="POST">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="product_id" class="form-label">Sélectionnez un produit existant</label>
                            <select class="form-select" id="product_id" name="product_id" required>
                                <option value="">Choisir un produit...</option>
                                {% for product in products %}
                                <option value="{{ product.id }}">{{ product.name }} - {{ product.category }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="target_audience_id" class="form-label">Public cible</label>
                            <select class="form-select" id="target_audience_id" name="target_audience_id" required>
                                <option value="">Choisir un profil client...</option>
                                {% for customer in customers %}
                                <option value="{{ customer.id }}">{{ customer.name }} ({{ customer.age }} ans, {{ customer.location }})</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="style" class="form-label">Style de description</label>
                            <select class="form-select" id="style" name="style">
                                <option value="descriptif" selected>Descriptif</option>
                                <option value="technique">Technique</option>
                                <option value="emotionnel">Émotionnel</option>
                                <option value="luxe">Haut de gamme</option>
                                <option value="minimaliste">Minimaliste</option>
                                <option value="storytelling">Storytelling</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="language" class="form-label">Langue</label>
                            <select class="form-select" id="language" name="language">
                                <option value="fr" selected>Français</option>
                                <option value="en">Anglais</option>
                                <option value="es">Espagnol</option>
                                <option value="de">Allemand</option>
                                <option value="it">Italien</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-4 d-flex align-items-end">
                        <div class="mb-3 w-100">
                            <button type="submit" name="action" value="generate_description" class="btn btn-success w-100">
                                <i class="fas fa-pen-fancy me-2"></i> Générer la description produit
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Générateur de Variantes -->
    <div class="card mb-5">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0">Générateur de Variantes Produit</h5>
        </div>
        <div class="card-body">
            <form action="{{ url_for('generate_product_content') }}" method="POST">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="product_id_variants" class="form-label">Sélectionnez un produit</label>
                            <select class="form-select" id="product_id_variants" name="product_id" required>
                                <option value="">Choisir un produit...</option>
                                {% for product in products %}
                                <option value="{{ product.id }}">{{ product.name }} - {{ product.category }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Types de variantes</label>
                            <div class="d-flex flex-wrap gap-2">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="couleurs" id="color_variant" name="variant_types">
                                    <label class="form-check-label" for="color_variant">
                                        Couleurs
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="tailles" id="size_variant" name="variant_types">
                                    <label class="form-check-label" for="size_variant">
                                        Tailles
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="matériaux" id="material_variant" name="variant_types">
                                    <label class="form-check-label" for="material_variant">
                                        Matériaux
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="capacité" id="capacity_variant" name="variant_types">
                                    <label class="form-check-label" for="capacity_variant">
                                        Capacité
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="puissance" id="power_variant" name="variant_types">
                                    <label class="form-check-label" for="power_variant">
                                        Puissance
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="options" id="options_variant" name="variant_types">
                                    <label class="form-check-label" for="options_variant">
                                        Options
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 offset-md-6">
                        <div class="d-grid">
                            <button type="submit" name="action" value="generate_variants" class="btn btn-info text-white">
                                <i class="fas fa-cubes me-2"></i> Générer les variantes
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Analyse Comparative -->
    <div class="card mb-5">
        <div class="card-header bg-warning text-dark">
            <h5 class="mb-0">Analyse Comparative des Produits</h5>
        </div>
        <div class="card-body">
            <form action="{{ url_for('generate_product_content') }}" method="POST">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="product_id_comparison" class="form-label">Votre produit</label>
                            <select class="form-select" id="product_id_comparison" name="product_id" required>
                                <option value="">Choisir un produit...</option>
                                {% for product in products %}
                                <option value="{{ product.id }}">{{ product.name }} - {{ product.category }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="competitor_names" class="form-label">Produits concurrents (séparés par virgules)</label>
                            <input type="text" class="form-control" id="competitor_names" name="competitor_names" 
                                   placeholder="Ex: Produit A, Produit B, Produit C">
                        </div>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-12">
                        <div class="mb-3">
                            <label for="competitor_details" class="form-label">Détails sur les concurrents (facultatif)</label>
                            <textarea class="form-control" id="competitor_details" name="competitor_details" rows="3"
                                placeholder="Ajoutez des détails sur les produits concurrents. Exemple: 'Produit A: Prix 29.99€, avantages X et Y, inconvénient Z'"></textarea>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 offset-md-6">
                        <div class="d-grid">
                            <button type="submit" name="action" value="generate_comparison" class="btn btn-warning">
                                <i class="fas fa-balance-scale me-2"></i> Générer l'analyse comparative
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Création Produit -->
<div class="modal fade" id="createProductModal" tabindex="-1" aria-labelledby="createProductModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createProductModalLabel">Créer un nouveau produit</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="createProductForm" action="{{ url_for('create_product') }}" method="POST">
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="name" class="form-label">Nom du produit *</label>
                                <input type="text" class="form-control" id="name" name="name" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="price" class="form-label">Prix *</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="price" name="price" step="0.01" min="0" required>
                                    <span class="input-group-text">€</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="category" class="form-label">Catégorie *</label>
                                <input type="text" class="form-control" id="category" name="category" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="boutique_id" class="form-label">Boutique associée</label>
                                <select class="form-select" id="boutique_id" name="boutique_id">
                                    <option value="">Sélectionner une boutique...</option>
                                    {% for boutique in boutiques %}
                                    <option value="{{ boutique.id }}">{{ boutique.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="base_description" class="form-label">Description de base</label>
                        <textarea class="form-control" id="base_description" name="base_description" rows="4" 
                                  placeholder="Description initiale du produit, caractéristiques principales, etc."></textarea>
                    </div>

                    <div class="mb-3">
                        <label for="image_url" class="form-label">URL de l'image</label>
                        <input type="url" class="form-control" id="image_url" name="image_url" 
                               placeholder="https://exemple.com/image.jpg">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="submit" form="createProductForm" class="btn btn-primary">Créer le produit</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Validation des formulaires
        const variantCheckboxes = document.querySelectorAll('input[name="variant_types"]');
        const variantForm = document.querySelector('button[value="generate_variants"]').closest('form');
        
        variantForm.addEventListener('submit', function(event) {
            const checked = Array.from(variantCheckboxes).some(checkbox => checkbox.checked);
            if (!checked) {
                event.preventDefault();
                alert('Veuillez sélectionner au moins un type de variante.');
            }
        });
    });
</script>
{% endblock %}