{% extends "layout.html" %}

{% block title %}{{ _('Métriques et Performances') }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">{{ _('Métriques et Performances') }}</h1>
    
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">{{ _('Filtres') }}</h5>
                </div>
                <div class="card-body">
                    <form method="GET" action="{{ url_for('metrics') }}" class="row g-3">
                        <div class="col-md-3">
                            <label for="category" class="form-label">{{ _('Catégorie') }}</label>
                            <select class="form-select" name="category" id="category">
                                <option value="">{{ _('Toutes') }}</option>
                                <option value="ai" {% if selected_category == 'ai' %}selected{% endif %}>{{ _('IA') }}</option>
                                <option value="generation" {% if selected_category == 'generation' %}selected{% endif %}>{{ _('Génération') }}</option>
                                <option value="user" {% if selected_category == 'user' %}selected{% endif %}>{{ _('Utilisateur') }}</option>
                                <option value="system" {% if selected_category == 'system' %}selected{% endif %}>{{ _('Système') }}</option>
                                <option value="import" {% if selected_category == 'import' %}selected{% endif %}>{{ _('Import') }}</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="start_date" class="form-label">{{ _('Date de début') }}</label>
                            <input type="date" class="form-control" name="start_date" id="start_date" value="{{ start_date }}">
                        </div>
                        <div class="col-md-3">
                            <label for="end_date" class="form-label">{{ _('Date de fin') }}</label>
                            <input type="date" class="form-control" name="end_date" id="end_date" value="{{ end_date }}">
                        </div>
                        <div class="col-md-3">
                            <label for="limit" class="form-label">{{ _('Nombre de résultats') }}</label>
                            <select class="form-select" name="limit" id="limit">
                                <option value="50" {% if limit == 50 %}selected{% endif %}>50</option>
                                <option value="100" {% if limit == 100 %}selected{% endif %}>100</option>
                                <option value="200" {% if limit == 200 %}selected{% endif %}>200</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <button type="submit" class="btn btn-primary">{{ _('Filtrer') }}</button>
                            <a href="{{ url_for('metrics') }}" class="btn btn-outline-secondary">{{ _('Réinitialiser') }}</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Résumé des métriques -->
    <div class="row mb-4">
        <div class="col-md-6 col-xl-3 mb-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <h6 class="text-muted">{{ _('Total des métriques') }}</h6>
                    <h2 class="mt-2 mb-3">{{ metrics_summary.total_count }}</h2>
                    <div class="progress">
                        <div class="progress-bar bg-success" style="width: {{ metrics_summary.success_rate }}%"></div>
                    </div>
                    <div class="small mt-2">{{ _('Taux de réussite') }}: {{ "%.1f"|format(metrics_summary.success_rate) }}%</div>
                </div>
            </div>
        </div>
        <div class="col-md-6 col-xl-3 mb-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <h6 class="text-muted">{{ _('Réussites / Erreurs') }}</h6>
                    <h2 class="mt-2 mb-3">{{ metrics_summary.success_count }} / {{ metrics_summary.error_count }}</h2>
                    <div class="d-flex justify-content-between">
                        <div class="small text-success">{{ _('Réussites') }}: {{ metrics_summary.success_count }}</div>
                        <div class="small text-danger">{{ _('Erreurs') }}: {{ metrics_summary.error_count }}</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6 col-xl-3 mb-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <h6 class="text-muted">{{ _('Temps de réponse moyen') }}</h6>
                    <h2 class="mt-2 mb-3">{{ "%.0f"|format(metrics_summary.avg_response_time) }} ms</h2>
                    <div class="small">{{ _('Temps de réponse moyen des appels API') }}</div>
                </div>
            </div>
        </div>
        <div class="col-md-6 col-xl-3 mb-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <h6 class="text-muted">{{ _('Catégories') }}</h6>
                    <div class="mt-3">
                        <canvas id="categoriesChart" width="100%" height="80"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Graphique des métriques dans le temps -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">{{ _('Tendance des métriques') }}</h5>
                </div>
                <div class="card-body">
                    <canvas id="metricsTimeChart" width="100%" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Tableau des dernières métriques -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">{{ _('Dernières métriques') }}</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>{{ _('ID') }}</th>
                                    <th>{{ _('Nom') }}</th>
                                    <th>{{ _('Catégorie') }}</th>
                                    <th>{{ _('Statut') }}</th>
                                    <th>{{ _('Temps') }}</th>
                                    <th>{{ _('Date') }}</th>
                                    <th>{{ _('Actions') }}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for metric in metrics_summary.latest_metrics %}
                                <tr>
                                    <td>{{ metric.id }}</td>
                                    <td>{{ metric.name }}</td>
                                    <td>
                                        <span class="badge bg-{{ 'primary' if metric.category == 'ai' else 'info' if metric.category == 'generation' else 'success' if metric.category == 'user' else 'warning' if metric.category == 'system' else 'secondary' }}">
                                            {{ metric.category or _('Non catégorisé') }}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge bg-{{ 'success' if metric.status == 'success' else 'danger' if metric.status == 'error' else 'warning' if metric.status == 'warning' else 'info' }}">
                                            {{ metric.status or _('Non défini') }}
                                        </span>
                                    </td>
                                    <td>{{ "%.0f"|format(metric.response_time) if metric.response_time else '-' }} ms</td>
                                    <td>{{ metric.created_at.strftime('%d/%m/%Y %H:%M:%S') }}</td>
                                    <td>
                                        <button type="button" class="btn btn-sm btn-outline-primary" 
                                                data-bs-toggle="modal" 
                                                data-bs-target="#metricDataModal" 
                                                data-metric-id="{{ metric.id }}" 
                                                data-metric-name="{{ metric.name }}"
                                                data-metric-data="{{ metric.data|tojson }}">
                                            <i class="bi bi-eye"></i> {{ _('Détails') }}
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal pour afficher les détails d'une métrique -->
    <div class="modal fade" id="metricDataModal" tabindex="-1" aria-labelledby="metricDataModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="metricDataModalLabel">{{ _('Détails de la métrique') }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <h6>{{ _('ID') }}: <span id="modal-metric-id"></span></h6>
                        <h6>{{ _('Nom') }}: <span id="modal-metric-name"></span></h6>
                    </div>
                    <div class="mb-3">
                        <h6>{{ _('Données JSON') }}:</h6>
                        <pre id="modal-metric-data" class="bg-light p-3 rounded"></pre>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Fermer') }}</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
<script>
    // Données pour le graphique des catégories
    const categoryData = {{ category_stats|tojson }};
    const categoryLabels = Object.keys(categoryData);
    const categoryValues = Object.values(categoryData);
    
    // Graphique des catégories
    const categoriesCtx = document.getElementById('categoriesChart').getContext('2d');
    const categoriesChart = new Chart(categoriesCtx, {
        type: 'doughnut',
        data: {
            labels: categoryLabels,
            datasets: [{
                data: categoryValues,
                backgroundColor: [
                    '#4e73df', // primary
                    '#36b9cc', // info
                    '#1cc88a', // success
                    '#f6c23e', // warning
                    '#e74a3b', // danger
                    '#858796'  // secondary
                ],
                hoverBackgroundColor: [
                    '#2e59d9',
                    '#2c9faf',
                    '#17a673',
                    '#dda20a',
                    '#be2617',
                    '#60616f'
                ],
                hoverBorderColor: "rgba(234, 236, 244, 1)",
            }],
        },
        options: {
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            cutout: '75%',
        }
    });
    
    // Données pour le graphique des métriques dans le temps
    const timeData = {{ time_series_data|tojson }};
    const timeLabels = timeData.map(item => item.date);
    const successData = timeData.map(item => item.success_count);
    const errorData = timeData.map(item => item.error_count);
    
    // Graphique des métriques dans le temps
    const timeCtx = document.getElementById('metricsTimeChart').getContext('2d');
    const timeChart = new Chart(timeCtx, {
        type: 'line',
        data: {
            labels: timeLabels,
            datasets: [
                {
                    label: '{{ _("Réussites") }}',
                    data: successData,
                    backgroundColor: 'rgba(28, 200, 138, 0.1)',
                    borderColor: 'rgba(28, 200, 138, 1)',
                    borderWidth: 2,
                    pointBackgroundColor: 'rgba(28, 200, 138, 1)',
                    pointBorderColor: '#fff',
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: 'rgba(28, 200, 138, 1)',
                    tension: 0.3
                },
                {
                    label: '{{ _("Erreurs") }}',
                    data: errorData,
                    backgroundColor: 'rgba(231, 74, 59, 0.1)',
                    borderColor: 'rgba(231, 74, 59, 1)',
                    borderWidth: 2,
                    pointBackgroundColor: 'rgba(231, 74, 59, 1)',
                    pointBorderColor: '#fff',
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: 'rgba(231, 74, 59, 1)',
                    tension: 0.3
                }
            ],
        },
        options: {
            maintainAspectRatio: false,
            scales: {
                x: {
                    grid: {
                        display: false
                    }
                },
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                }
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                }
            }
        }
    });
    
    // Modal pour afficher les détails des métriques
    const metricDataModal = document.getElementById('metricDataModal');
    metricDataModal.addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget;
        const metricId = button.getAttribute('data-metric-id');
        const metricName = button.getAttribute('data-metric-name');
        const metricData = JSON.parse(button.getAttribute('data-metric-data'));
        
        const modalTitle = metricDataModal.querySelector('#metricDataModalLabel');
        const modalMetricId = metricDataModal.querySelector('#modal-metric-id');
        const modalMetricName = metricDataModal.querySelector('#modal-metric-name');
        const modalMetricData = metricDataModal.querySelector('#modal-metric-data');
        
        modalTitle.textContent = '{{ _("Détails de la métrique") }}: ' + metricName;
        modalMetricId.textContent = metricId;
        modalMetricName.textContent = metricName;
        modalMetricData.textContent = JSON.stringify(metricData, null, 2);
    });
</script>
{% endblock %}