{% extends 'layout.html' %}

{% block title %}Modifier un profil client{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row mb-4">
        <div class="col">
            <h1>Modifier le profil client</h1>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Tableau de bord</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('profiles') }}">Profils</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('view_customer', customer_id=customer.id) }}">{{ customer.name }}</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Modifier</li>
                </ol>
            </nav>
        </div>
    </div>

    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Informations du client</h5>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('edit_customer', customer_id=customer.id) }}">
                        <div class="mb-3">
                            <label for="name" class="form-label">Nom</label>
                            <input type="text" class="form-control" id="name" name="name" value="{{ customer.name }}" required>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="age" class="form-label">Âge</label>
                                <input type="number" class="form-control" id="age" name="age" value="{{ customer.age }}">
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="gender" class="form-label">Genre</label>
                                <select class="form-select" id="gender" name="gender">
                                    <option value="MALE" {% if customer.gender == 'MALE' %}selected{% endif %}>Homme</option>
                                    <option value="FEMALE" {% if customer.gender == 'FEMALE' %}selected{% endif %}>Femme</option>
                                    <option value="OTHER" {% if customer.gender not in ['MALE', 'FEMALE'] %}selected{% endif %}>Autre</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-8 mb-3">
                                <label for="location" class="form-label">Localisation</label>
                                <input type="text" class="form-control" id="location" name="location" value="{{ customer.location }}">
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                <label for="country_code" class="form-label">Pays</label>
                                <select class="form-select" id="country_code" name="country_code">
                                    <option value="">Non spécifié</option>
                                    <option value="US" {% if customer.country_code == 'US' %}selected{% endif %}>États-Unis</option>
                                    <option value="CA" {% if customer.country_code == 'CA' %}selected{% endif %}>Canada</option>
                                    <option value="GB" {% if customer.country_code == 'GB' %}selected{% endif %}>Royaume-Uni</option>
                                    <option value="FR" {% if customer.country_code == 'FR' %}selected{% endif %}>France</option>
                                    <option value="DE" {% if customer.country_code == 'DE' %}selected{% endif %}>Allemagne</option>
                                    <option value="IT" {% if customer.country_code == 'IT' %}selected{% endif %}>Italie</option>
                                    <option value="ES" {% if customer.country_code == 'ES' %}selected{% endif %}>Espagne</option>
                                    <option value="JP" {% if customer.country_code == 'JP' %}selected{% endif %}>Japon</option>
                                    <option value="AU" {% if customer.country_code == 'AU' %}selected{% endif %}>Australie</option>
                                    <option value="BR" {% if customer.country_code == 'BR' %}selected{% endif %}>Brésil</option>
                                    <option value="IN" {% if customer.country_code == 'IN' %}selected{% endif %}>Inde</option>
                                    <option value="CN" {% if customer.country_code == 'CN' %}selected{% endif %}>Chine</option>
                                    <option value="MX" {% if customer.country_code == 'MX' %}selected{% endif %}>Mexique</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="language" class="form-label">Langue</label>
                            <input type="text" class="form-control" id="language" name="language" value="{{ customer.language }}">
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="occupation" class="form-label">Profession</label>
                                <input type="text" class="form-control" id="occupation" name="occupation" value="{{ customer.occupation }}">
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="education" class="form-label">Niveau d'éducation</label>
                                <select class="form-select" id="education" name="education">
                                    <option value="">Non spécifié</option>
                                    <option value="high school" {% if customer.education == 'high school' %}selected{% endif %}>Lycée</option>
                                    <option value="some college" {% if customer.education == 'some college' %}selected{% endif %}>Quelques années d'université</option>
                                    <option value="bachelor" {% if customer.education == 'bachelor' %}selected{% endif %}>Licence/Bachelor</option>
                                    <option value="master" {% if customer.education == 'master' %}selected{% endif %}>Master</option>
                                    <option value="doctorate" {% if customer.education == 'doctorate' %}selected{% endif %}>Doctorat</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="income_level" class="form-label">Niveau de revenu</label>
                                <select class="form-select" id="income_level" name="income_level">
                                    <option value="">Non spécifié</option>
                                    <option value="budget" {% if customer.income_level == 'budget' %}selected{% endif %}>Budget-conscious</option>
                                    <option value="middle" {% if customer.income_level == 'middle' %}selected{% endif %}>Middle income</option>
                                    <option value="affluent" {% if customer.income_level == 'affluent' %}selected{% endif %}>Affluent</option>
                                    <option value="luxury" {% if customer.income_level == 'luxury' %}selected{% endif %}>Luxury consumer</option>
                                </select>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="shopping_frequency" class="form-label">Fréquence d'achat</label>
                                <select class="form-select" id="shopping_frequency" name="shopping_frequency">
                                    <option value="">Non spécifié</option>
                                    <option value="rarely" {% if customer.shopping_frequency == 'rarely' %}selected{% endif %}>Rarement</option>
                                    <option value="occasionally" {% if customer.shopping_frequency == 'occasionally' %}selected{% endif %}>Occasionnellement</option>
                                    <option value="frequently" {% if customer.shopping_frequency == 'frequently' %}selected{% endif %}>Fréquemment</option>
                                    <option value="very frequently" {% if customer.shopping_frequency == 'very frequently' %}selected{% endif %}>Très fréquemment</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="interests" class="form-label">Centres d'intérêt</label>
                            <input type="text" class="form-control" id="interests" name="interests" value="{{ customer.interests }}">
                            <small class="form-text text-muted">Séparés par des virgules</small>
                        </div>
                        
                        <div class="mb-3">
                            <label for="objectif" class="form-label">Objectif du persona</label>
                            <select class="form-select" id="objectif" name="objectif" onchange="handleObjectifChange(this)">
                                <option value="">-- Sélectionnez un objectif --</option>
                                <option value="Accroître sa productivité personnelle" {% if customer.objectif == 'Accroître sa productivité personnelle' %}selected{% endif %}>Accroître sa productivité personnelle</option>
                                <option value="Améliorer son bien-être et sa santé" {% if customer.objectif == 'Améliorer son bien-être et sa santé' %}selected{% endif %}>Améliorer son bien-être et sa santé</option>
                                <option value="Développer ses compétences professionnelles" {% if customer.objectif == 'Développer ses compétences professionnelles' %}selected{% endif %}>Développer ses compétences professionnelles</option>
                                <option value="Optimiser ses finances personnelles" {% if customer.objectif == 'Optimiser ses finances personnelles' %}selected{% endif %}>Optimiser ses finances personnelles</option>
                                <option value="Créer ou développer son entreprise" {% if customer.objectif == 'Créer ou développer son entreprise' %}selected{% endif %}>Créer ou développer son entreprise</option>
                                <option value="Améliorer sa vie familiale et sociale" {% if customer.objectif == 'Améliorer sa vie familiale et sociale' %}selected{% endif %}>Améliorer sa vie familiale et sociale</option>
                                <option value="Adopter un mode de vie plus durable" {% if customer.objectif == 'Adopter un mode de vie plus durable' %}selected{% endif %}>Adopter un mode de vie plus durable</option>
                                <option value="Enrichir ses loisirs et hobbies" {% if customer.objectif == 'Enrichir ses loisirs et hobbies' %}selected{% endif %}>Enrichir ses loisirs et hobbies</option>
                                <option value="Améliorer son apparence et style" {% if customer.objectif == 'Améliorer son apparence et style' %}selected{% endif %}>Améliorer son apparence et style</option>
                                <option value="Optimiser son environnement de vie" {% if customer.objectif == 'Optimiser son environnement de vie' %}selected{% endif %}>Optimiser son environnement de vie</option>
                                <option value="Développer ses relations sociales" {% if customer.objectif == 'Développer ses relations sociales' %}selected{% endif %}>Développer ses relations sociales</option>
                                <option value="Voyager et découvrir de nouvelles cultures" {% if customer.objectif == 'Voyager et découvrir de nouvelles cultures' %}selected{% endif %}>Voyager et découvrir de nouvelles cultures</option>
                                <option value="Gagner du temps dans ses tâches quotidiennes" {% if customer.objectif == 'Gagner du temps dans ses tâches quotidiennes' %}selected{% endif %}>Gagner du temps dans ses tâches quotidiennes</option>
                                <option value="Acquérir de nouvelles connaissances" {% if customer.objectif == 'Acquérir de nouvelles connaissances' %}selected{% endif %}>Acquérir de nouvelles connaissances</option>
                                <option value="Sauvegarder et organiser ses souvenirs" {% if customer.objectif == 'Sauvegarder et organiser ses souvenirs' %}selected{% endif %}>Sauvegarder et organiser ses souvenirs</option>
                                <option value="custom">✏️ Saisir un objectif personnalisé...</option>
                            </select>
                            <input type="text" class="form-control mt-2 d-none" id="objectif_custom" name="objectif_custom" 
                                   placeholder="Saisissez l'objectif personnalisé..." value="{{ customer.objectif if customer.objectif not in ['Accroître sa productivité personnelle', 'Améliorer son bien-être et sa santé', 'Développer ses compétences professionnelles', 'Optimiser ses finances personnelles', 'Créer ou développer son entreprise', 'Améliorer sa vie familiale et sociale', 'Adopter un mode de vie plus durable', 'Enrichir ses loisirs et hobbies', 'Améliorer son apparence et style', 'Optimiser son environnement de vie', 'Développer ses relations sociales', 'Voyager et découvrir de nouvelles cultures', 'Gagner du temps dans ses tâches quotidiennes', 'Acquérir de nouvelles connaissances', 'Sauvegarder et organiser ses souvenirs'] else '' }}">
                            <small class="form-text text-muted">L'objectif guide la génération du persona et les stratégies marketing</small>
                        </div>
                        
                        <div class="mb-3">
                            <label for="preferred_device" class="form-label">Appareil préféré</label>
                            <input type="text" class="form-control" id="preferred_device" name="preferred_device" value="{{ customer.preferred_device }}">
                        </div>

                        <div class="mb-3">
                            <label for="niche_market_id" class="form-label">Marché de niche</label>
                            <select class="form-select" id="niche_market_id" name="niche_market_id">
                                <option value="">-- Aucun --</option>
                                {% for niche in niches %}
                                <option value="{{ niche.id }}" {% if customer.niche_market_id == niche.id %}selected{% endif %}>{{ niche.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="persona" class="form-label">Persona</label>
                            <textarea class="form-control" id="persona" name="persona" rows="6">{{ customer.persona }}</textarea>
                        </div>
                        
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a href="{{ url_for('view_customer', customer_id=customer.id) }}" class="btn btn-secondary me-md-2">
                                <img src="{{ url_for('static', filename='images/ninja-logo.png') }}" alt="" style="width: 16px; height: 16px; margin-right: 8px;">Annuler
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <img src="{{ url_for('static', filename='images/ninja-trophy.png') }}" alt="" style="width: 16px; height: 16px; margin-right: 8px;">Enregistrer les modifications
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">Actions</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('view_customer', customer_id=customer.id) }}" class="btn btn-outline-primary">
                            <img src="{{ url_for('static', filename='images/ninja-logo.png') }}" alt="" style="width: 16px; height: 16px; margin-right: 8px;">Retour au profil
                        </a>
                        <a href="{{ url_for('delete_customer', customer_id=customer.id) }}" class="btn btn-outline-danger" 
                           onclick="return confirm('Êtes-vous sûr de vouloir supprimer ce client? Cette action est irréversible.');">
                            <img src="{{ url_for('static', filename='images/ninja-action.png') }}" alt="" style="width: 16px; height: 16px; margin-right: 8px;"> Supprimer ce client
                        </a>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header bg-warning text-white">
                    <h5 class="mb-0">Aide</h5>
                </div>
                <div class="card-body">
                    <p>
                        Modifiez les informations du profil client selon vos besoins. Tous les champs sont optionnels sauf le nom.
                    </p>
                    <p>
                        Pour les centres d'intérêt, séparez chaque élément par une virgule.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function handleObjectifChange(selectElement) {
    const customInput = document.getElementById('objectif_custom');
    
    if (selectElement.value === 'custom') {
        customInput.classList.remove('d-none');
        customInput.focus();
        customInput.setAttribute('required', 'required');
    } else {
        customInput.classList.add('d-none');
        customInput.removeAttribute('required');
        customInput.value = '';
    }
}

// Au chargement de la page, vérifier si un objectif personnalisé existe
document.addEventListener('DOMContentLoaded', function() {
    const selectElement = document.getElementById('objectif');
    const customInput = document.getElementById('objectif_custom');
    
    // Si le champ personnalisé a une valeur et qu'elle n'est pas dans les options prédéfinies
    if (customInput.value && customInput.value.trim() !== '') {
        const predefinedOptions = Array.from(selectElement.options).map(opt => opt.value);
        if (!predefinedOptions.includes(customInput.value)) {
            selectElement.value = 'custom';
            customInput.classList.remove('d-none');
            customInput.setAttribute('required', 'required');
        }
    }
});
</script>

{% endblock %}