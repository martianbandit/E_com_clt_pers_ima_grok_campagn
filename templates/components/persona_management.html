<!-- Module avancé de gestion des personas -->
<div class="card mb-4">
    <div class="card-header bg-gradient-primary text-white">
        <h5 class="mb-0">
            <i class="fas fa-user-circle me-2"></i>
            Gestion Avancée des Personas
        </h5>
    </div>
    <div class="card-body">
        <!-- Onglets de navigation -->
        <ul class="nav nav-tabs mb-3" id="personaTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="current-personas-tab" data-bs-toggle="tab" data-bs-target="#current-personas" type="button" role="tab">
                    <i class="fas fa-users me-1"></i>
                    Personas Actuels
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="search-personas-tab" data-bs-toggle="tab" data-bs-target="#search-personas" type="button" role="tab">
                    <i class="fas fa-search me-1"></i>
                    Rechercher
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="generate-persona-tab" data-bs-toggle="tab" data-bs-target="#generate-persona" type="button" role="tab">
                    <i class="fas fa-magic me-1"></i>
                    Générer
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="persona-stats-tab" data-bs-toggle="tab" data-bs-target="#persona-stats" type="button" role="tab">
                    <i class="fas fa-chart-bar me-1"></i>
                    Statistiques
                </button>
            </li>
        </ul>

        <!-- Contenu des onglets -->
        <div class="tab-content" id="personaTabContent">
            <!-- Onglet 1: Personas actuels -->
            <div class="tab-pane fade show active" id="current-personas" role="tabpanel">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="mb-0">Personas associés à ce client</h6>
                    <button class="btn btn-sm btn-outline-primary" onclick="refreshPersonas()">
                        <i class="fas fa-sync-alt me-1"></i>Actualiser
                    </button>
                </div>
                
                <div id="personas-list">
                    <div class="text-center text-muted">
                        <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                        <p>Chargement des personas...</p>
                    </div>
                </div>
            </div>

            <!-- Onglet 2: Recherche de personas -->
            <div class="tab-pane fade" id="search-personas" role="tabpanel">
                <h6 class="mb-3">Rechercher des personas existants</h6>
                
                <form id="search-form" class="mb-3">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Titre du persona</label>
                            <input type="text" class="form-control" name="title" placeholder="Ex: Jeune maman urbaine">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Tranche d'âge</label>
                            <select class="form-select" name="age_range">
                                <option value="">Toutes les tranches</option>
                                <option value="18-25">18-25 ans</option>
                                <option value="26-35">26-35 ans</option>
                                <option value="36-45">36-45 ans</option>
                                <option value="46-55">46-55 ans</option>
                                <option value="56-65">56-65 ans</option>
                                <option value="65+">65+ ans</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Genre</label>
                            <select class="form-select" name="gender_affinity">
                                <option value="">Tous les genres</option>
                                <option value="Homme">Homme</option>
                                <option value="Femme">Femme</option>
                                <option value="Non-binaire">Non-binaire</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Niveau de revenus</label>
                            <select class="form-select" name="income_bracket">
                                <option value="">Tous les niveaux</option>
                                <option value="Faible">Faible</option>
                                <option value="Moyen">Moyen</option>
                                <option value="Élevé">Élevé</option>
                                <option value="Très élevé">Très élevé</option>
                            </select>
                        </div>
                        <div class="col-12 mb-3">
                            <label class="form-label">Mots-clés dans la description</label>
                            <input type="text" class="form-control" name="description_keywords" placeholder="Ex: technologie sport famille">
                        </div>
                    </div>
                    
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-search me-1"></i>Rechercher
                        </button>
                        <button type="reset" class="btn btn-outline-secondary">
                            <i class="fas fa-eraser me-1"></i>Effacer
                        </button>
                    </div>
                </form>

                <div id="search-results">
                    <div class="text-center text-muted">
                        <i class="fas fa-search fa-2x mb-3"></i>
                        <p>Utilisez le formulaire ci-dessus pour rechercher des personas</p>
                    </div>
                </div>
            </div>

            <!-- Onglet 3: Génération de persona -->
            <div class="tab-pane fade" id="generate-persona" role="tabpanel">
                <h6 class="mb-3">Générer un nouveau persona</h6>
                
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Génération automatique :</strong> Un persona sera créé automatiquement à partir des données de ce client.
                </div>
                
                <form id="generate-form">
                    <div class="mb-3">
                        <label class="form-label">Titre du persona (optionnel)</label>
                        <input type="text" class="form-control" name="title" placeholder="Laissez vide pour génération automatique">
                        <small class="form-text text-muted">Si vide, un titre sera généré automatiquement</small>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="save_as_primary" id="save_as_primary" checked>
                            <label class="form-check-label" for="save_as_primary">
                                Définir comme persona principal
                            </label>
                        </div>
                    </div>
                    
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-magic me-1"></i>Générer le Persona
                        </button>
                        <button type="button" class="btn btn-outline-info" onclick="enrichPersonaWithAI()">
                            <i class="fas fa-robot me-1"></i>Enrichir avec IA
                        </button>
                    </div>
                </form>
                
                <div id="generation-result" class="mt-3"></div>
            </div>

            <!-- Onglet 4: Statistiques -->
            <div class="tab-pane fade" id="persona-stats" role="tabpanel">
                <h6 class="mb-3">Statistiques des personas</h6>
                
                <div id="stats-content">
                    <div class="text-center text-muted">
                        <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                        <p>Chargement des statistiques...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal d'assignation de persona -->
<div class="modal fade" id="assignPersonaModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Assigner un persona</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="assign-form">
                    <input type="hidden" id="assign-persona-id">
                    
                    <div class="mb-3">
                        <label class="form-label">Type d'assignation</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="is_primary" id="primary-yes" value="true">
                            <label class="form-check-label" for="primary-yes">
                                Persona principal (remplace l'actuel)
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="is_primary" id="primary-no" value="false" checked>
                            <label class="form-check-label" for="primary-no">
                                Persona secondaire
                            </label>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Score de pertinence</label>
                        <input type="range" class="form-range" name="relevance_score" min="0" max="1" step="0.1" value="1.0" id="relevance-range">
                        <div class="d-flex justify-content-between">
                            <small>0%</small>
                            <small id="relevance-display">100%</small>
                            <small>100%</small>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Notes (optionnel)</label>
                        <textarea class="form-control" name="notes" rows="3" placeholder="Commentaires sur cette assignation..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-primary" onclick="submitAssignation()">Assigner</button>
            </div>
        </div>
    </div>
</div>

<style>
.persona-card {
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
    transition: all 0.3s ease;
}

.persona-card:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    transform: translateY(-2px);
}

.persona-primary {
    border-left: 4px solid #007bff;
    background-color: #f8f9ff;
}

.persona-secondary {
    border-left: 4px solid #6c757d;
}

.persona-avatar {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid #007bff;
}

.relevance-score {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.8em;
    font-weight: bold;
}

.score-high { background-color: #d4edda; color: #155724; }
.score-medium { background-color: #fff3cd; color: #856404; }
.score-low { background-color: #f8d7da; color: #721c24; }

.search-result-item {
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 10px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.search-result-item:hover {
    background-color: #f8f9fa;
    border-color: #007bff;
}

.stats-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 15px;
}

.stats-number {
    font-size: 2rem;
    font-weight: bold;
}

.ai-enhancement-badge {
    background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
    color: white;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.75em;
    font-weight: bold;
}
</style>

<script>
// Variables globales
const customerId = {{ customer.id if customer else 'null' }};
let currentPersonas = [];
let personaStats = null;

// Initialisation
document.addEventListener('DOMContentLoaded', function() {
    if (customerId) {
        loadCurrentPersonas();
        loadPersonaStats();
    }
    
    // Événements des formulaires
    document.getElementById('search-form').addEventListener('submit', handleSearch);
    document.getElementById('generate-form').addEventListener('submit', handleGeneration);
    
    // Mise à jour du score de pertinence
    document.getElementById('relevance-range').addEventListener('input', function() {
        document.getElementById('relevance-display').textContent = Math.round(this.value * 100) + '%';
    });
});

// Chargement des personas actuels
async function loadCurrentPersonas() {
    try {
        const response = await fetch(`/api/customers/${customerId}/personas`);
        const data = await response.json();
        
        if (data.success) {
            currentPersonas = data.personas;
            displayCurrentPersonas(data.personas);
        } else {
            showError('Erreur lors du chargement des personas: ' + data.error);
        }
    } catch (error) {
        showError('Erreur de connexion: ' + error.message);
    }
}

// Affichage des personas actuels
function displayCurrentPersonas(personas) {
    const container = document.getElementById('personas-list');
    
    if (personas.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted">
                <i class="fas fa-user-slash fa-2x mb-3"></i>
                <p>Aucun persona assigné à ce client</p>
                <button class="btn btn-outline-primary" onclick="switchToTab('generate-persona-tab')">
                    <i class="fas fa-plus me-1"></i>Créer un persona
                </button>
            </div>
        `;
        return;
    }
    
    let html = '';
    personas.forEach(persona => {
        const scoreClass = persona.relevance_score >= 0.8 ? 'score-high' : 
                          persona.relevance_score >= 0.5 ? 'score-medium' : 'score-low';
        
        html += `
            <div class="persona-card ${persona.is_primary ? 'persona-primary' : 'persona-secondary'}">
                <div class="d-flex align-items-center mb-3">
                    ${persona.avatar_url ? 
                        `<img src="${persona.avatar_url}" alt="Avatar" class="persona-avatar me-3">` :
                        `<div class="persona-avatar me-3 d-flex align-items-center justify-content-center bg-light">
                            <i class="fas fa-user text-muted"></i>
                         </div>`
                    }
                    <div class="flex-grow-1">
                        <h6 class="mb-1">
                            ${persona.title}
                            ${persona.is_primary ? '<span class="badge bg-primary ms-2">Principal</span>' : ''}
                        </h6>
                        <p class="text-muted mb-0 small">${persona.description}</p>
                    </div>
                </div>
                
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <small class="text-muted">Score de pertinence:</small>
                        <span class="relevance-score ${scoreClass} ms-2">
                            ${Math.round(persona.relevance_score * 100)}%
                        </span>
                    </div>
                    <div class="col-md-6 text-end">
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-info" onclick="enrichPersona(${persona.persona_id})" title="Enrichir avec IA">
                                <i class="fas fa-robot"></i>
                            </button>
                            <button class="btn btn-outline-warning" onclick="editPersonaAssociation(${persona.association_id})" title="Modifier l'association">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-outline-danger" onclick="removePersonaAssociation(${persona.association_id})" title="Retirer">
                                <i class="fas fa-unlink"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                ${persona.notes ? `
                    <div class="mt-2">
                        <small class="text-muted">Notes:</small>
                        <p class="small mb-0">${persona.notes}</p>
                    </div>
                ` : ''}
                
                <div class="mt-2">
                    <small class="text-muted">Créé le: ${new Date(persona.created_at).toLocaleDateString('fr-FR')}</small>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// Recherche de personas
async function handleSearch(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    const criteria = {};
    
    for (let [key, value] of formData.entries()) {
        if (value.trim()) {
            criteria[key] = value.trim();
        }
    }
    
    if (Object.keys(criteria).length === 0) {
        showError('Veuillez spécifier au moins un critère de recherche');
        return;
    }
    
    try {
        const response = await fetch('/api/personas/search', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                criteria: criteria,
                limit: 10
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            displaySearchResults(data.personas);
        } else {
            showError('Erreur lors de la recherche: ' + data.error);
        }
    } catch (error) {
        showError('Erreur de connexion: ' + error.message);
    }
}

// Affichage des résultats de recherche
function displaySearchResults(personas) {
    const container = document.getElementById('search-results');
    
    if (personas.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted">
                <i class="fas fa-search-minus fa-2x mb-3"></i>
                <p>Aucun persona trouvé avec ces critères</p>
            </div>
        `;
        return;
    }
    
    let html = `<h6 class="mb-3">${personas.length} persona(s) trouvé(s)</h6>`;
    
    personas.forEach(persona => {
        html += `
            <div class="search-result-item" onclick="showAssignModal(${persona.id}, '${persona.title}')">
                <div class="d-flex align-items-center">
                    ${persona.avatar_url ? 
                        `<img src="${persona.avatar_url}" alt="Avatar" class="persona-avatar me-3">` :
                        `<div class="persona-avatar me-3 d-flex align-items-center justify-content-center bg-light">
                            <i class="fas fa-user text-muted"></i>
                         </div>`
                    }
                    <div class="flex-grow-1">
                        <h6 class="mb-1">${persona.title}</h6>
                        <p class="text-muted mb-1 small">${persona.description}</p>
                        <div class="d-flex gap-3">
                            ${persona.age_range ? `<small class="text-muted"><i class="fas fa-birthday-cake me-1"></i>${persona.age_range}</small>` : ''}
                            ${persona.gender_affinity ? `<small class="text-muted"><i class="fas fa-venus-mars me-1"></i>${persona.gender_affinity}</small>` : ''}
                            ${persona.income_bracket ? `<small class="text-muted"><i class="fas fa-coins me-1"></i>${persona.income_bracket}</small>` : ''}
                        </div>
                    </div>
                    <div>
                        <button class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-plus me-1"></i>Assigner
                        </button>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// Génération de persona
async function handleGeneration(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    const title = formData.get('title');
    const saveAsPrimary = formData.has('save_as_primary');
    
    const resultContainer = document.getElementById('generation-result');
    resultContainer.innerHTML = `
        <div class="alert alert-info">
            <i class="fas fa-spinner fa-spin me-2"></i>Génération du persona en cours...
        </div>
    `;
    
    try {
        const response = await fetch(`/api/customers/${customerId}/personas/generate`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                title: title || null,
                save_as_primary: saveAsPrimary
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            resultContainer.innerHTML = `
                <div class="alert alert-success">
                    <i class="fas fa-check-circle me-2"></i>
                    <strong>Persona généré avec succès !</strong><br>
                    <strong>Titre:</strong> ${data.persona.title}<br>
                    <strong>Description:</strong> ${data.persona.description}
                </div>
            `;
            
            // Recharger la liste des personas
            loadCurrentPersonas();
            
            // Réinitialiser le formulaire
            event.target.reset();
        } else {
            resultContainer.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Erreur lors de la génération: ${data.error}
                </div>
            `;
        }
    } catch (error) {
        resultContainer.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Erreur de connexion: ${error.message}
            </div>
        `;
    }
}

// Enrichissement IA d'un persona
async function enrichPersona(personaId) {
    try {
        showLoading('Enrichissement du persona avec l\'IA...');
        
        const response = await fetch(`/api/personas/enrich/${personaId}`, {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.success) {
            showSuccess('Persona enrichi avec succès !');
            loadCurrentPersonas(); // Recharger la liste
        } else {
            showError('Erreur lors de l\'enrichissement: ' + data.error);
        }
    } catch (error) {
        showError('Erreur de connexion: ' + error.message);
    } finally {
        hideLoading();
    }
}

// Chargement des statistiques
async function loadPersonaStats() {
    try {
        const response = await fetch('/api/personas/stats');
        const data = await response.json();
        
        if (data.success) {
            personaStats = data.stats;
            displayPersonaStats(data.stats);
        }
    } catch (error) {
        console.error('Erreur chargement stats:', error);
    }
}

// Affichage des statistiques
function displayPersonaStats(stats) {
    const container = document.getElementById('stats-content');
    
    let html = `
        <div class="row">
            <div class="col-md-6 mb-3">
                <div class="stats-card">
                    <div class="stats-number">${stats.total_personas}</div>
                    <div>Personas Totaux</div>
                </div>
            </div>
            <div class="col-md-6 mb-3">
                <div class="stats-card">
                    <div class="stats-number">${stats.total_associations}</div>
                    <div>Associations Totales</div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-6 mb-3">
                <div class="stats-card">
                    <div class="stats-number">${stats.personas_with_avatar}</div>
                    <div>Avec Avatar</div>
                </div>
            </div>
            <div class="col-md-6 mb-3">
                <div class="stats-card">
                    <div class="stats-number">${Math.round((stats.personas_with_avatar / stats.total_personas) * 100) || 0}%</div>
                    <div>Completion Rate</div>
                </div>
            </div>
        </div>
    `;
    
    if (stats.personas_by_niche && Object.keys(stats.personas_by_niche).length > 0) {
        html += `
            <h6 class="mt-4 mb-3">Répartition par niche</h6>
            <div class="row">
        `;
        
        for (const [niche, count] of Object.entries(stats.personas_by_niche)) {
            html += `
                <div class="col-md-6 mb-2">
                    <div class="d-flex justify-content-between align-items-center p-2 bg-light rounded">
                        <span>${niche}</span>
                        <span class="badge bg-primary">${count}</span>
                    </div>
                </div>
            `;
        }
        
        html += `</div>`;
    }
    
    container.innerHTML = html;
}

// Fonctions utilitaires
function refreshPersonas() {
    loadCurrentPersonas();
}

function switchToTab(tabId) {
    document.getElementById(tabId).click();
}

function showAssignModal(personaId, personaTitle) {
    document.getElementById('assign-persona-id').value = personaId;
    document.querySelector('#assignPersonaModal .modal-title').textContent = `Assigner: ${personaTitle}`;
    
    const modal = new bootstrap.Modal(document.getElementById('assignPersonaModal'));
    modal.show();
}

async function submitAssignation() {
    const personaId = document.getElementById('assign-persona-id').value;
    const formData = new FormData(document.getElementById('assign-form'));
    
    const data = {
        persona_id: parseInt(personaId),
        is_primary: formData.get('is_primary') === 'true',
        relevance_score: parseFloat(formData.get('relevance_score')),
        notes: formData.get('notes')
    };
    
    try {
        const response = await fetch(`/api/customers/${customerId}/personas/assign`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            showSuccess('Persona assigné avec succès !');
            bootstrap.Modal.getInstance(document.getElementById('assignPersonaModal')).hide();
            loadCurrentPersonas();
        } else {
            showError('Erreur lors de l\'assignation: ' + result.error);
        }
    } catch (error) {
        showError('Erreur de connexion: ' + error.message);
    }
}

function showLoading(message) {
    // Implémentation du loading
}

function hideLoading() {
    // Masquer le loading
}

function showSuccess(message) {
    // Afficher un message de succès
    console.log('Succès:', message);
}

function showError(message) {
    // Afficher un message d'erreur
    console.error('Erreur:', message);
}
</script>